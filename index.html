<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>돈의 흐름</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: white;
            color: #374151;
            overflow-x: hidden;
            display: flex;
            min-height: 100vh;
        }

        .main-layout {
            display: flex;
            width: 100%;
        }

        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .svg-container {
            touch-action: none; /* 터치 이벤트 제어를 위해 추가 */
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .steps-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
            gap: 2rem;
            padding-top: 2rem;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            transition: all 0.5s;
            border: 1px solid transparent;
        }

        .step.active-red {
            background-color: #fef2f2;
            color: #b91c1c;
            border-color: #fecaca;
        }

        .step.active-orange {
            background-color: #fff7ed;
            color: #c2410c;
            border-color: #fed7aa;
        }

        .step.active-green {
            background-color: #f0fdf4;
            color: #166534;
            border-color: #bbf7d0;
        }

        .step.inactive {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .step-number {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .step-number.red { background-color: #ef4444; }
        .step-number.orange { background-color: #f97316; }
        .step-number.green { background-color: #22c55e; }
        .step-number.gray { background-color: #9ca3af; }

        .reset-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .reset-btn:hover {
            background-color: #e5e7eb;
            color: #374151;
            border-color: #9ca3af;
        }

        .node-group {
            cursor: grab;
        }
        
        .node-group:active {
            cursor: grabbing;
        }

        .connection-line {
            transition: all 0.7s;
        }

        .solution-panel {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: 24rem;
            max-width: 90vw;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.5s ease-out;
            z-index: 50;
        }

        .solution-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .solution-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .solution-card {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .solution-details {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .solution-left {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .solution-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .solution-right {
            text-align: right;
        }

        .savings-amount {
            font-weight: bold;
            font-size: 1.125rem;
            color: #059669;
        }

        .savings-period {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .solution-tip {
            font-size: 0.75rem;
            color: #6b7280;
            background: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }

        .solution-btn {
            width: 100%;
            background-color: #dc2626;
            color: white;
            font-weight: 500;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .solution-btn:hover {
            background-color: #b91c1c;
        }

        .usage-guide {
            text-align: center;
            margin: 1rem 0 2rem;
        }

        .usage-text {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .analysis-text {
            color: #ef4444;
            font-size: 0.875rem;
            animation: pulse 2s infinite;
        }

        .guide-panel {
            width: 350px;
            flex-shrink: 0;
            background-color: #f9fafb;
            border-left: 1px solid #e5e7eb;
            padding: 2rem;
            overflow-y: auto;
        }

        .guide-panel h2 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .guide-panel h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .guide-panel p {
            font-size: 0.875rem;
            line-height: 1.6;
            color: #4b5563;
        }
        
        .guide-panel p strong {
            color: #1f2937;
            font-weight: 600;
        }

        .guide-panel .tip {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        @media (max-width: 1024px) {
            .main-layout {
                flex-direction: column;
            }
            .guide-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid #e5e7eb;
            }
        }

        @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
        @keyframes bounce { 0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); } 50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); } }
        .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="container">
            <!-- 인터랙션 단계 표시 -->
            <div class="steps-container">
                <div id="step1" class="step inactive">
                    <span class="step-number gray">1</span>
                    <span>탐색 (Explore)</span>
                </div>
                <div id="step2" class="step inactive">
                    <span class="step-number gray">2</span>
                    <span>발견 (Discover)</span>
                </div>
                <div id="step3" class="step inactive">
                    <span class="step-number gray">3</span>
                    <span>해결 (Solve)</span>
                </div>
                
                <!-- 리셋 버튼 -->
                <button id="reset-btn" class="reset-btn" style="display: none;" title="처음 상태로 돌아가기">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                    <span>초기화</span>
                </button>
            </div>
            <!-- 메인 시각화 영역 -->
            <div class="svg-container">
                <svg id="money-map-svg" width="800" height="600" style="max-width: 100%; height: auto;">
                    <!-- 배경 그라데이션 -->
                    <defs>
                        <radialGradient id="bgGradient" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" stop-color="rgba(156, 163, 175, 0.03)" />
                            <stop offset="100%" stop-color="rgba(255, 255, 255, 0)" />
                        </radialGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge>
                                 <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                        <!-- 화살표 마커 정의 -->
                        <marker id="arrowhead" markerWidth="30" markerHeight="21" refX="27" refY="10.5" orient="auto" markerUnits="userSpaceOnUse">
                            <polygon points="0 0, 30 10.5, 0 21" fill="#dc2626" />
                        </marker>
                        <marker id="arrowhead-inactive" markerWidth="30" markerHeight="21" refX="27" refY="10.5" orient="auto" markerUnits="userSpaceOnUse">
                            <polygon points="0 0, 30 10.5, 0 21" fill="#9ca3af" />
                        </marker>
                    </defs>
                    <circle cx="400" cy="300" r="200" fill="url(#bgGradient)" />
                    <!-- 연결선들 -->
                    <g id="connections"></g>
                    <!-- 노드들 -->
                    <g id="nodes"></g>
                </svg>
            </div>
            <!-- 사용 안내 -->
            <div class="usage-guide">
                <p id="usage-text" class="usage-text">💡 먼저 중앙의 '총 지출' 노드를 클릭하여 분석을 시작하세요.</p>
                <p id="analysis-text" class="analysis-text" style="display: none;"></p>
            </div>
            <!-- 솔루션 패널 -->
            <div id="solution-panel" class="solution-panel" style="display: none;"></div>
        </div>
        <div class="guide-panel">
            <h2>💡 돈의 지도 활용법</h2>
            <p>이 도구는 당신의 지출 흐름을 시각적으로 분석하고, 절약 가능한 부분을 찾아 스마트한 제안을 제공합니다. 아래의 3단계를 따라 당신의 돈의 흐름을 탐험해보세요.</p>
            
            <h4>1. 탐색 (Explore)</h4>
            <p>먼저 중앙에 있는 <strong>'총 지출'</strong> 노드를 클릭하여 분석을 시작하세요. 전체 지출이 각 항목으로 어떻게 흘러가는지 한눈에 파악할 수 있습니다.</p>

            <h4>2. 발견 (Discover)</h4>
            <p>관심 있는 지출 항목(예: <strong>'통신비'</strong>, <strong>'주거비'</strong>)을 클릭하면 AI가 해당 항목의 세부 내역을 심층 분석합니다. 비효율적인 지출로 판단되는 항목은 <strong>'⚠️'</strong> 아이콘과 함께 붉게 표시됩니다.</p>

            <h4>3. 해결 (Solve)</h4>
            <p>분석이 완료되면 화면 하단에 <strong>'스마트 제안'</strong> 패널이 나타납니다. 이 패널에서는 통신 요금제 변경, 세액 공제 신청 등 즉시 실행할 수 있는 구체적인 절약 방법을 확인할 수 있습니다.</p>

            <h4>기타 기능</h4>
            <p><strong>드래그 & 드롭:</strong> 각 지출 노드를 마우스로 끌어 원하는 위치로 옮기며 지도를 자유롭게 재구성할 수 있습니다.<br>
            <strong>초기화:</strong> 상단의 '초기화' 버튼을 누르면 모든 분석 상태가 초기화됩니다.</p>
        </div>
    </div>
    <script>
        // --- 상태 및 데이터 ---
        let state = {
            selectedNode: null,
            discoveryPhase: 0,
            showSolution: false,
            animationStep: 0,
            draggedNode: null,
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
        };
        const nodes = [
            { id: 'center', x: 400, y: 300, vx: 0, vy: 0, size: 60, label: '월 총 지출', amount: '3,245,600원', type: 'center', detail: '2025년 1월' },
            { id: 'home', x: 200, y: 150, vx: 0, vy: 0, size: 50, label: '주거비', amount: '1,200,000원', type: 'major', detail: 'K은행 ****-2847', subDetails: ['월세 100만원', '관리비 20만원'] },
            { id: 'food', x: 600, y: 150, vx: 0, vy: 0, size: 45, label: '식비', amount: '856,200원', type: 'major', detail: 'S은행 ****-1234', subDetails: ['외식 52만원', '마트 24만원', '배달 11만원'] },
            { id: 'transport', x: 150, y: 380, vx: 0, vy: 0, size: 40, label: '교통비', amount: '485,300원', type: 'regular', detail: 'H카드 ****-5678', subDetails: ['주유비 32만원', '지하철 8만원', '택시 6만원'] },
            { id: 'shopping', x: 650, y: 380, vx: 0, vy: 0, size: 35, label: '쇼핑', amount: '324,800원', type: 'regular', detail: 'S카드 ****-9012', subDetails: ['의류 18만원', '온라인 12만원'] },
            { id: 'phone', x: 280, y: 480, vx: 0, vy: 0, size: 30, label: '통신비', amount: '89,500원', type: 'small', detail: 'AlphaT 자동이체', subDetails: ['요금제 6.5만원', '부가서비스 2.4만원'], inefficient: true, reason: '유사 서비스 대비 요금 높음' },
            { id: 'utility', x: 520, y: 480, vx: 0, vy: 0, size: 30, label: '공과금', amount: '156,800원', type: 'small', detail: 'W은행 ****-7890', subDetails: ['전기료 8만원', '가스료 5만원', '수도료 2만원'], inefficient: true, reason: '누진세 3단계 진입' }
        ];
        const connections = [
            { from: 'center', to: 'home' },
            { from: 'center', to: 'food' },
            { from: 'center', to: 'transport' },
            { from: 'center', to: 'shopping' },
            { from: 'center', to: 'phone' },
            { from: 'center', to: 'utility' }
        ];

        // --- 물리 엔진 설정 ---
        const physics = {
            repulsion: 8000,
            spring: 0.05,
            idealLength: 250,
            centering: 0.01,
            damping: 0.95
        };

        // --- DOM 요소 ---
        const svg = document.getElementById('money-map-svg');
        const nodesGroup = document.getElementById('nodes');
        const connectionsGroup = document.getElementById('connections');

        // --- 유틸리티 함수 ---
        function calculateLinePoints(fromNode, toNode) {
            const dx = toNode.x - fromNode.x;
            const dy = toNode.y - fromNode.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance === 0) return { startX: fromNode.x, startY: fromNode.y, endX: toNode.x, endY: toNode.y };
            const unitX = dx / distance;
            const unitY = dy / distance;
            const startX = fromNode.x + unitX * fromNode.size;
            const startY = fromNode.y + unitY * fromNode.size;
            const endX = toNode.x - unitX * toNode.size;
            const endY = toNode.y - unitY * toNode.size;
            return { startX, startY, endX, endY };
        }
        function isConnectionActive(connection) { return state.selectedNode && (connection.from === state.selectedNode || connection.to === state.selectedNode); }
        function isNodeHighlighted(node) {
            if (!state.selectedNode) return false;
            if (node.id === state.selectedNode) return true;
            return connections.some(conn => (conn.from === state.selectedNode && conn.to === node.id) || (conn.to === state.selectedNode && conn.from === node.id));
        }

        // --- 이벤트 핸들러 ---
        function handleNodeClick(nodeId) {
            if (state.selectedNode === nodeId) return; // 이미 선택된 노드는 다시 처리하지 않음

            state.selectedNode = nodeId;
            state.discoveryPhase = 0;
            state.showSolution = false;
            state.animationStep++;
            startAnimationSequence();
        }
        function handleReset() {
            state.selectedNode = null;
            state.discoveryPhase = 0;
            state.showSolution = false;
            state.animationStep = 0;
        }
        
        // --- 드래그 핸들러 ---
        function getMousePosition(evt) {
            const CTM = svg.getScreenCTM();
            let clientX, clientY;
            if (evt.touches && evt.touches.length > 0) {
                clientX = evt.touches[0].clientX;
                clientY = evt.touches[0].clientY;
            } else if (evt.changedTouches && evt.changedTouches.length > 0) {
                clientX = evt.changedTouches[0].clientX;
                clientY = evt.changedTouches[0].clientY;
            } else {
                clientX = evt.clientX;
                clientY = evt.clientY;
            }
            return {
                x: (clientX - CTM.e) / CTM.a,
                y: (clientY - CTM.f) / CTM.d
            };
        }

        function onDragStart(evt) {
            evt.preventDefault();
            const targetNodeId = evt.target.closest('.node-group')?.dataset.id;
            if (targetNodeId) {
                state.draggedNode = nodes.find(n => n.id === targetNodeId);
                if (state.draggedNode) {
                    state.isDragging = true;
                    const mousePos = getMousePosition(evt);
                    state.dragStartX = mousePos.x;
                    state.dragStartY = mousePos.y;
                }
            }
        }
        
        function onDrag(evt) {
            if (state.isDragging && state.draggedNode && state.draggedNode.id !== 'center') {
                evt.preventDefault();
                const mousePos = getMousePosition(evt);
                state.draggedNode.x = mousePos.x;
                state.draggedNode.y = mousePos.y;
                state.draggedNode.vx = 0; // 드래그 중에는 물리적 속도 초기화
                state.draggedNode.vy = 0;
            }
        }

        function onDragEnd(evt) {
            const wasDragging = state.isDragging;
            const draggedNodeId = state.draggedNode?.id;

            state.isDragging = false;
            state.draggedNode = null;

            if (wasDragging) {
                const mousePos = getMousePosition(evt);
                const dist = Math.sqrt(Math.pow(mousePos.x - state.dragStartX, 2) + Math.pow(mousePos.y - state.dragStartY, 2));
                
                if (dist < 5) { // 드래그 거리가 짧으면 클릭으로 간주
                    if (draggedNodeId) { // 'center' 노드를 포함한 모든 노드 클릭 처리
                        handleNodeClick(draggedNodeId);
                    }
                }
            }
        }

        // --- 애니메이션 및 UI 업데이트 ---
        function startAnimationSequence() {
            if (state.selectedNode && state.selectedNode !== 'center') {
                setTimeout(() => { state.discoveryPhase = 1; }, 1000);
                setTimeout(() => { state.discoveryPhase = 2; }, 2500);
                setTimeout(() => { state.showSolution = true; }, 3500);
            }
        }

        function updatePhysics() {
            nodes.forEach(node1 => {
                if (node1.id === 'center' || state.draggedNode?.id === node1.id) return;

                // 다른 노드와의 반발력
                nodes.forEach(node2 => {
                    if (node1 === node2) return;
                    const dx = node1.x - node2.x;
                    const dy = node1.y - node2.y;
                    const distSq = dx * dx + dy * dy;
                    if (distSq < 1) distSq = 1; // 0으로 나누는 것 방지
                    const force = physics.repulsion / distSq;
                    node1.vx += (dx / Math.sqrt(distSq)) * force;
                    node1.vy += (dy / Math.sqrt(distSq)) * force;
                });

                // 연결된 노드와의 인력 (스프링)
                connections.forEach(conn => {
                    if (conn.from === node1.id || conn.to === node1.id) {
                        const otherNodeId = conn.from === node1.id ? conn.to : conn.from;
                        const otherNode = nodes.find(n => n.id === otherNodeId);
                        const dx = otherNode.x - node1.x;
                        const dy = otherNode.y - node1.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        const displacement = dist - physics.idealLength;
                        const force = displacement * physics.spring;
                        node1.vx += (dx / dist) * force;
                        node1.vy += (dy / dist) * force;
                    }
                });

                // 중앙으로의 인력
                const dx = 400 - node1.x;
                const dy = 300 - node1.y;
                node1.vx += dx * physics.centering;
                node1.vy += dy * physics.centering;

                // 감속
                node1.vx *= physics.damping;
                node1.vy *= physics.damping;

                // 위치 업데이트
                node1.x += node1.vx;
                node1.y += node1.vy;
            });
        }
        
        function mainLoop() {
            if (!state.isDragging) {
                updatePhysics();
            }
            // UI 업데이트는 물리 계산과 별개로 항상 실행되어야 부드러운 드래그가 가능
            updateUI();
            requestAnimationFrame(mainLoop);
        }

        function updateUI() {
            updateSteps();
            updateNodes();
            updateConnections();
            updateSolutionPanel();
            updateUsageGuide();
            updateResetButton();
        }

        function updateSteps() {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            if (state.selectedNode) { step1.className = 'step active-red'; step1.querySelector('.step-number').className = 'step-number red'; } 
            else { step1.className = 'step inactive'; step1.querySelector('.step-number').className = 'step-number gray'; }
            if (state.discoveryPhase >= 1) { step2.className = 'step active-orange'; step2.querySelector('.step-number').className = 'step-number orange'; } 
            else { step2.className = 'step inactive'; step2.querySelector('.step-number').className = 'step-number gray'; }
            if (state.showSolution) { step3.className = 'step active-green'; step3.querySelector('.step-number').className = 'step-number green'; } 
            else { step3.className = 'step inactive'; step3.querySelector('.step-number').className = 'step-number gray'; }
        }

        function updateResetButton() { document.getElementById('reset-btn').style.display = state.selectedNode ? 'flex' : 'none'; }

        function updateConnections() {
            connectionsGroup.innerHTML = '';

            const amounts = nodes
                .filter(n => n.type !== 'center')
                .map(n => parseInt(n.amount.replace(/[,원]/g, '')));
            const minAmount = Math.min(...amounts);
            const maxAmount = Math.max(...amounts);
            const minStroke = 1.5;
            const maxStroke = 10;

            function getStrokeWidth(amountStr) {
                const amount = parseInt(amountStr.replace(/[,원]/g, ''));
                if (maxAmount === minAmount) return (minStroke + maxStroke) / 2;
                // 금액에 로그를 취해 스케일을 조정하여 작은 금액도 보이게 함
                const logAmount = Math.log(amount);
                const logMin = Math.log(minAmount);
                const logMax = Math.log(maxAmount);
                return minStroke + (maxStroke - minStroke) * (logAmount - logMin) / (logMax - logMin);
            }

            connections.forEach(connection => {
                const fromNode = nodes.find(n => n.id === connection.from);
                const toNode = nodes.find(n => n.id === connection.to);
                const isActive = isConnectionActive(connection);
                const { startX, startY, endX, endY } = calculateLinePoints(fromNode, toNode);
                
                const strokeWidth = getStrokeWidth(toNode.amount);

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', startX);
                line.setAttribute('y1', startY);
                line.setAttribute('x2', endX);
                line.setAttribute('y2', endY);
                line.setAttribute('stroke', isActive ? '#dc2626' : '#9ca3af');
                line.setAttribute('stroke-width', isActive ? strokeWidth * 1.5 : strokeWidth);
                line.setAttribute('opacity', isActive ? 1 : 0.5);
                line.setAttribute('marker-end', isActive ? 'url(#arrowhead)' : 'url(#arrowhead-inactive)');
                if (isActive) line.setAttribute('filter', 'url(#glow)');
                connectionsGroup.appendChild(line);
            });
        }

        function updateNodes() {
            nodesGroup.innerHTML = '';
            nodes.forEach(node => {
                const isHighlighted = isNodeHighlighted(node);
                const isInefficient = node.inefficient && state.discoveryPhase >= 1;
                const showWarningBorder = node.inefficient && (isHighlighted || isInefficient);

                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'node-group');
                g.setAttribute('data-id', node.id);
                g.setAttribute('transform', `translate(${node.x}, ${node.y})`);

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('r', node.size);
                circle.setAttribute('fill', isInefficient ? '#dc2626' : '#e5e7eb');
                circle.setAttribute('stroke', isHighlighted ? '#dc2626' : '#d1d5db');
                circle.setAttribute('stroke-width', isHighlighted ? 4 : 1);
                circle.setAttribute('opacity', 0.9);
                if (isHighlighted) circle.setAttribute('filter', 'url(#glow)');
                g.appendChild(circle);

                if (showWarningBorder) {
                    const warningBorder = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    warningBorder.setAttribute('r', node.size + 8);
                    warningBorder.setAttribute('fill', 'none');
                    warningBorder.setAttribute('stroke', '#dc2626');
                    warningBorder.setAttribute('stroke-width', 2);
                    warningBorder.setAttribute('stroke-dasharray', '5,3');
                    warningBorder.setAttribute('opacity', 0.8);
                    warningBorder.className = 'animate-pulse';
                    g.appendChild(warningBorder);
                }
                
                if (isInefficient) {
                    const pingCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    pingCircle.setAttribute('r', node.size + 10);
                    pingCircle.setAttribute('fill', 'none');
                    pingCircle.setAttribute('stroke', '#dc2626');
                    pingCircle.setAttribute('stroke-width', 3);
                    pingCircle.setAttribute('opacity', 0);
                    pingCircle.className = 'animate-ping';
                    g.appendChild(pingCircle);
                }
                
                let displayText = '';
                if (node.type === 'center') { displayText = '총 지출'; } 
                else {
                    if (node.detail.includes('카드')) displayText = node.detail.split(' ')[0];
                    else if (node.detail.includes('은행')) displayText = node.detail.split(' ')[0];
                    else if (node.detail.includes('AlphaT')) displayText = 'AlphaT';
                    else displayText = node.detail.split(' ')[0];
                }
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('y', 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('font-size', node.type === 'center' ? '14' : '12');
                text.setAttribute('fill', isInefficient ? 'white' : '#4b5563');
                text.textContent = displayText;
                g.appendChild(text);

                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('y', node.size + 18);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('font-size', '14');
                label.setAttribute('font-weight', 'bold');
                label.setAttribute('fill', '#374151');
                label.textContent = node.label;
                g.appendChild(label);

                const amount = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                amount.setAttribute('y', node.size + 32);
                amount.setAttribute('text-anchor', 'middle');
                amount.setAttribute('font-size', '14');
                amount.setAttribute('font-weight', 'bold');
                amount.setAttribute('fill', isHighlighted ? '#dc2626' : '#6b7280');
                amount.textContent = node.amount;
                g.appendChild(amount);

                const detail = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                detail.setAttribute('y', node.size + 46);
                detail.setAttribute('text-anchor', 'middle');
                detail.setAttribute('font-size', '12');
                detail.setAttribute('fill', '#6b7280');
                detail.textContent = node.detail;
                g.appendChild(detail);

                if (isHighlighted) {
                    let yOffset = node.size + 64;
                    if (node.inefficient && node.reason) {
                        const reasonText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        reasonText.setAttribute('y', yOffset);
                        reasonText.setAttribute('text-anchor', 'middle');
                        reasonText.setAttribute('font-size', '12');
                        reasonText.setAttribute('font-weight', 'bold');
                        reasonText.setAttribute('fill', '#ef4444');
                        reasonText.textContent = `[!] ${node.reason}`;
                        g.appendChild(reasonText);
                        yOffset += 18;
                    }
                    if (node.subDetails) {
                        node.subDetails.forEach((subDetail, idx) => {
                            const subText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            subText.setAttribute('y', yOffset + (idx * 14));
                            subText.setAttribute('text-anchor', 'middle');
                            subText.setAttribute('font-size', '12');
                            subText.setAttribute('font-weight', '500');
                            subText.setAttribute('fill', '#dc2626');
                            subText.textContent = `• ${subDetail}`;
                            g.appendChild(subText);
                        });
                    }
                }

                if (isInefficient) {
                    const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                    foreignObject.setAttribute('x', node.size - 8);
                    foreignObject.setAttribute('y', -node.size + 8);
                    foreignObject.setAttribute('width', 16);
                    foreignObject.setAttribute('height', 16);
                    foreignObject.innerHTML = '<div style="color: #f59e0b; animation: bounce 1s infinite;">⚠️</div>';
                    g.appendChild(foreignObject);
                }
                
                nodesGroup.appendChild(g);
            });
        }

        function updateSolutionPanel() {
            const panel = document.getElementById('solution-panel');
            if (state.showSolution && state.selectedNode) {
                panel.style.display = 'block';
                let nodeData = nodes.find(n => n.id === state.selectedNode);
                let content = `<div class="solution-header"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2"><path d="M9 12l2 2 4-4"/><path d="M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.745 3.745 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.745 3.745 0 0 1 3.296-1.043A3.745 3.745 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.745 3.745 0 0 1 3.296 1.043 3.745 3.745 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12z"/></svg><h3 style="font-size: 1.125rem; font-weight: bold; color: #374151;">💡 스마트 제안</h3></div><div class="solution-content">`;
                
                if (state.selectedNode === 'phone') {
                    content += `<p style="color: #6b7280;"><strong>AlphaT 자동이체</strong> 요금이 유사 서비스 대비 26% 높습니다</p><div class="solution-card"><div class="solution-details"><div class="solution-left"><div class="solution-action"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg><span style="font-weight: 500; color: #374151;">알뜰폰으로 변경</span></div><div style="font-size: 0.875rem; color: #6b7280;">현재: AlphaT 5G 프리미어 → 제안: BetaT 알뜰폰 5G</div></div><div class="solution-right"><div class="savings-amount">-23,000원/월</div><div class="savings-period">연간 276,000원 절약</div></div></div><div class="solution-tip">💡 동일 데이터 제공, 통화품질 99% 동일</div></div><button class="solution-btn"><span>알뜰폰 신청하기</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14m-7-7 7 7-7 7"/></svg></button>`;
                } else if (state.selectedNode === 'utility') {
                    content += `<p style="color: #6b7280;"><strong>W은행 ****-7890</strong> 계좌의 전기료가 누진세 3단계입니다</p><div class="solution-card"><div class="solution-details"><div class="solution-left"><div class="solution-action"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><path d="M9 12l2 2 4-4"/><path d="M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.745 3.745 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.745 3.745 0 0 1 3.296-1.043A3.745 3.745 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.745 3.745 0 0 1 3.296 1.043 3.745 3.745 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12z"/></svg><span style="font-weight: 500; color: #374151;">에너지 요금 최적화</span></div><div style="font-size: 0.875rem; color: #6b7280;">전기료 누진세 3단계 → 2단계로 절약</div></div><div class="solution-right"><div class="savings-amount">-34,500원/월</div><div class="savings-period">연간 414,000원 절약</div></div></div><div class="solution-tip">💡 스마트 플러그 + 시간대별 요금제 변경</div></div><button class="solution-btn"><span>에너지 절약 플랜 시작하기</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14m-7-7 7 7-7 7"/></svg></button>`;
                } else if (state.selectedNode === 'home') {
                    content += `<p style="color: #6b7280;"><strong>K은행 ****-2847</strong> 월세 관련 세액공제 미신청 상태</p><div class="solution-card"><div class="solution-details"><div class="solution-left"><div class="solution-action"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg><span style="font-weight: 500; color: #374151;">월세 세액공제 신청</span></div><div style="font-size: 0.875rem; color: #6b7280;">연 소득 7천만원 이하 → 월세 750만원 한도 12% 공제</div></div><div class="solution-right"><div class="savings-amount">-90,000원/년</div><div class="savings-period">세금 환급</div></div></div><div class="solution-tip">💡 홈택스에서 5분 만에 신청 완료 가능</div></div><button class="solution-btn"><span>홈택스에서 신청하기</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14m-7-7 7 7-7 7"/></svg></button>`;
                }
                
                content += `</div>`;
                panel.innerHTML = content;
            } else {
                panel.style.display = 'none';
            }
        }
        function updateUsageGuide() {
            const usageText = document.getElementById('usage-text');
            const analysisText = document.getElementById('analysis-text');
            
            if (!state.selectedNode) {
                usageText.style.display = 'block';
                analysisText.style.display = 'none';
                usageText.textContent = '💡 먼저 중앙의 \'총 지출\' 노드를 클릭하여 분석을 시작하세요.';
            } else if (state.selectedNode === 'center') {
                usageText.style.display = 'block';
                analysisText.style.display = 'none';
                usageText.textContent = '💡 분석하고 싶은 지출 항목을 클릭하세요.';
            } else if (state.selectedNode && !state.showSolution) {
                usageText.style.display = 'none';
                analysisText.style.display = 'block';
                
                let text = 'AI가 ';
                if (state.selectedNode === 'phone') text += 'AlphaT 요금제를';
                else if (state.selectedNode === 'home') text += 'K은행 월세 혜택을';
                else if (state.selectedNode === 'utility') text += 'W은행 전기료를';
                else text += '지출 패턴을';
                text += ' 분석하고 있습니다...';
                
                analysisText.textContent = text;
            } else {
                usageText.style.display = 'none';
                analysisText.style.display = 'none';
            }
        }
        
        // --- 초기화 및 이벤트 리스너 설정 ---
        document.getElementById('reset-btn').onclick = handleReset;
        
        svg.addEventListener('mousedown', onDragStart);
        svg.addEventListener('mousemove', onDrag);
        svg.addEventListener('mouseup', onDragEnd);
        svg.addEventListener('mouseleave', onDragEnd);

        svg.addEventListener('touchstart', onDragStart);
        svg.addEventListener('touchmove', onDrag);
        svg.addEventListener('touchend', onDragEnd);

        mainLoop(); // 애니메이션 루프 시작
    </script>
</body>
</html>
